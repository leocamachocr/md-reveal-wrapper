<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>Presentación Reveal.js</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Reveal.js Core -->
    <link rel="stylesheet" href="{{ reveal_cdn }}/{{ reveal_version }}/reveal.min.css">
    <link rel="stylesheet" href="{{ reveal_cdn }}/{{ reveal_version }}/theme/{{ theme }}.min.css" id="theme">

    <!-- Highlight.js CSS -->
    <link rel="stylesheet"
          href="https://cdn.jsdelivr.net/gh/highlightjs/cdn-release@11.7.0/build/styles/{{ highlight_theme }}.min.css">

    <!-- Reveal.js Scripts -->
    <script src="{{ reveal_cdn }}/{{ reveal_version }}/reveal.min.js"></script>
    <script src="{{ reveal_cdn }}/{{ reveal_version }}/plugin/highlight/highlight.js"></script>
    <script src="{{ reveal_cdn }}/{{ reveal_version }}/plugin/math/math.min.js"></script>

    {% if custom_theme %}
    <link rel="stylesheet" href="assets/{{ custom_theme }}">
    {% endif %}
</head>
<body>
<div class="reveal">
    {% if show_header_trail == "true" %}
    <div id="header-trail" class="header-trail"></div>
    {% endif %}
    <div class="slides">
        {{ slides | safe }}
    </div>
</div>

<script>
    Reveal.initialize({
        controls: {{ enable_controls | lower }},
        progress: {{ enable_progress | lower }},
        history: {{ enable_history | lower }},
        center: {{ align_center | lower }},
        transition: '{{ transition }}',
        width: {{ width }},
        height: {{ height }},
        margin: {{ margin }},
        minScale: {{ min_scale }},
        maxScale: {{ max_scale }},
        plugins: [ RevealMath.MathJax3, RevealHighlight ]
    });

    // Lightbox para imágenes
    Reveal.on('ready', () => {
        document.querySelectorAll('img[data-preview-image]').forEach(img => {
            img.addEventListener('click', () => {
                const overlay = document.createElement('div');
                overlay.classList.add('image-overlay');

                const fullImage = document.createElement('img');
                fullImage.src = img.src;

                overlay.appendChild(fullImage);
                overlay.addEventListener('click', () => overlay.remove());

                document.body.appendChild(overlay);
            });
        });

        if (window.hljs) {
            document.querySelectorAll('pre code').forEach(block => hljs.highlightElement(block));
        }
    });

    // Breadcrumb dinámico
    const breadcrumb = document.getElementById("header-trail");
    Reveal.on('slidechanged', event => {
        if (breadcrumb) {
            breadcrumb.innerHTML = "";
            const trail = (event.currentSlide.getAttribute("data-breadcrumb") || "").split(">");
            trail.forEach((part, index) => {
                const span = document.createElement("span");
                span.className = "crumb";

                const text = document.createElement("span");
                text.className = "crumb-text";
                text.textContent = part.trim();
                text.title = part.trim();

                span.appendChild(text);
                breadcrumb.appendChild(span);

                if (index < trail.length - 1) {
                    const sep = document.createElement("span");
                    sep.className = "crumb-separator";
                    sep.textContent = "›";
                    breadcrumb.appendChild(sep);
                }
            });
        }
    });

    // Auto-ajuste de fuente por altura del contenido
    function adjustFontToFit(slide) {
    const content = slide.querySelector('.slide-content');
    if (!content) return;

    const maxHeight = parseInt(slide.getAttribute('data-max-height')) || 600;
    const minFontSize = 14; // en píxeles
    const maxSteps = 5;    // evita bucles largos

    let step = 0;
    let fontSize = parseFloat(getComputedStyle(content).fontSize);

    while (content.scrollHeight > maxHeight && fontSize > minFontSize && step < maxSteps) {
        console.log(`Adjunsting fond size: ${fontSize}px`);
        fontSize -= 1;
        content.style.fontSize = `${fontSize}px`;
        step++;
    }
}


    Reveal.on('slidechanged', event => {
        adjustFontToFit(event.currentSlide);
    });

    Reveal.on('ready', event => {
        adjustFontToFit(event.currentSlide);
    });
</script>
</body>
</html>
